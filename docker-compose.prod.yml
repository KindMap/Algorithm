version: "3.8"

services:
  redis:
    image: redis:7-alpine
    container_name: kindmap-redis
    restart: unless-stopped
    networks:
      - kindmap-network
    expose:
      - "6379"
    volumes:
      - redis-data:/data
    command: >
      redis-server 
      --appendonly yes 
      --maxmemory 512mb 
      --maxmemory-policy allkeys-lru 
      --notify-keyspace-events "" 
      --client-output-buffer-limit pubsub 32mb 8mb 60
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  fastapi:
    image: ${REPOSITORY_URI}:fastapi-${IMAGE_TAG}
    # container_name 제거 (replicas 사용 시 필수)
    restart: unless-stopped
    env_file:
      - /home/ec2-user/.env
    environment:
      ALLOWED_ORIGINS: "http://localhost:3000,http://localhost:5173,http://127.0.0.1:3000,http://35.92.117.143,http://inha-capstone-03-frontend.s3-website-us-west-2.amazonaws.com,https://kindmap-for-you.cloud"
      REDIS_PUBSUB_ENABLED: "true"
      REDIS_PUBSUB_CHANNEL: "kindmap_events"
      # Whisper 모델 저장 경로를 내부 볼륨으로 지정
      WHISPER_MODEL_DIR: "/root/.cache/huggingface"
    expose:
      - "8001"
    networks:
      - kindmap-network
    depends_on:
      redis:
        condition: service_healthy
    
    # Gunicorn 사용: 프로세스 관리 및 타임아웃 제어에 유리
    # --timeout 120: 무거운 작업(STT/경로탐색) 중 워커킬 방지 (502 해결)
    # workers 1: 컨테이너 당 1개의 워커만 띄우고, 컨테이너 개수(replicas)로 스케일링
    command: >
      gunicorn app.main:app
      --workers 1
      --worker-class uvicorn.workers.UvicornWorker
      --bind 0.0.0.0:8001
      --timeout 300
      --keep-alive 120
      --worker-connections 1000

    # Whisper 모델 캐싱을 위한 볼륨 마운트 => 컨테이너 재시작할 때마다 모델을 다운로드하지 않도록 조정
    # 컨테이너 재시작 시 모델 다운로드 시간 단축
    volumes:
      - /home/ec2-user/model_cache:/root/.cache/huggingface

    deploy:
      replicas: 3
      resources:
        limits:
          cpus: "1.0"
          # [상향 조정] Whisper + 경로탐색 그래프 로드 시 1GB는 부족할 수 있음
          memory: 2G 
        reservations:
          cpus: "0.5"
          memory: 1G
    
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8001/health').read()",
        ]
      interval: 30s
      timeout: 10s # 타임아웃을 조금 더 넉넉하게
      retries: 3
      start_period: 60s

  nginx:
    image: ${REPOSITORY_URI}:nginx-${IMAGE_TAG}
    container_name: kindmap-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - fastapi
    networks:
      - kindmap-network
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

networks:
  kindmap-network:
    driver: bridge

volumes:
  redis-data:
    driver: local